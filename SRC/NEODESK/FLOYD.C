#include "dither.h"

unsigned char floydbytes[65][8] = {
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
0x7F, 0xFF, 0xFF, 0xFF, 0xF7, 0xFF, 0xFF, 0xFF, 
0x77, 0xFF, 0xFF, 0xFF, 0xF7, 0xFF, 0xFF, 0xFF, 
0x77, 0xFF, 0xFF, 0xFF, 0x77, 0xFF, 0xFF, 0xFF, 
0x77, 0xFF, 0xDF, 0xFF, 0x77, 0xFF, 0xFF, 0xFF, 
0x77, 0xFF, 0xDF, 0xFF, 0x77, 0xFF, 0xFD, 0xFF, 
0x77, 0xFF, 0xDD, 0xFF, 0x77, 0xFF, 0xFD, 0xFF, 
0x77, 0xFF, 0xDD, 0xFF, 0x77, 0xFF, 0xDD, 0xFF, 
0x57, 0xFF, 0xDD, 0xFF, 0x77, 0xFF, 0xDD, 0xFF, 
0x57, 0xFF, 0xDD, 0xFF, 0x75, 0xFF, 0xDD, 0xFF, 
0x55, 0xFF, 0xDD, 0xFF, 0x75, 0xFF, 0xDD, 0xFF, 
0x55, 0xFF, 0xDD, 0xFF, 0x55, 0xFF, 0xDD, 0xFF, 
0x55, 0xFF, 0x5D, 0xFF, 0x55, 0xFF, 0xDD, 0xFF, 
0x55, 0xFF, 0x5D, 0xFF, 0x55, 0xFF, 0xD5, 0xFF, 
0x55, 0xFF, 0x55, 0xFF, 0x55, 0xFF, 0xD5, 0xFF, 
0x55, 0xFF, 0x55, 0xFF, 0x55, 0xFF, 0x55, 0xFF, 
0x55, 0xBF, 0x55, 0xFF, 0x55, 0xFF, 0x55, 0xFF, 
0x55, 0xBF, 0x55, 0xFF, 0x55, 0xFB, 0x55, 0xFF, 
0x55, 0xBB, 0x55, 0xFF, 0x55, 0xFB, 0x55, 0xFF, 
0x55, 0xBB, 0x55, 0xFF, 0x55, 0xBB, 0x55, 0xFF, 
0x55, 0xBB, 0x55, 0xEF, 0x55, 0xBB, 0x55, 0xFF, 
0x55, 0xBB, 0x55, 0xEF, 0x55, 0xBB, 0x55, 0xFE, 
0x55, 0xBB, 0x55, 0xEE, 0x55, 0xBB, 0x55, 0xFE, 
0x55, 0xBB, 0x55, 0xEE, 0x55, 0xBB, 0x55, 0xEE, 
0x55, 0xAB, 0x55, 0xEE, 0x55, 0xBB, 0x55, 0xEE, 
0x55, 0xAB, 0x55, 0xEE, 0x55, 0xBA, 0x55, 0xEE, 
0x55, 0xAA, 0x55, 0xEE, 0x55, 0xBA, 0x55, 0xEE, 
0x55, 0xAA, 0x55, 0xEE, 0x55, 0xAA, 0x55, 0xEE, 
0x55, 0xAA, 0x55, 0xAE, 0x55, 0xAA, 0x55, 0xEE, 
0x55, 0xAA, 0x55, 0xAE, 0x55, 0xAA, 0x55, 0xEA, 
0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xEA, 
0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 
0x15, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 
0x15, 0xAA, 0x55, 0xAA, 0x51, 0xAA, 0x55, 0xAA, 
0x11, 0xAA, 0x55, 0xAA, 0x51, 0xAA, 0x55, 0xAA, 
0x11, 0xAA, 0x55, 0xAA, 0x11, 0xAA, 0x55, 0xAA, 
0x11, 0xAA, 0x45, 0xAA, 0x11, 0xAA, 0x55, 0xAA, 
0x11, 0xAA, 0x45, 0xAA, 0x11, 0xAA, 0x54, 0xAA, 
0x11, 0xAA, 0x44, 0xAA, 0x11, 0xAA, 0x54, 0xAA, 
0x11, 0xAA, 0x44, 0xAA, 0x11, 0xAA, 0x44, 0xAA, 
0x01, 0xAA, 0x44, 0xAA, 0x11, 0xAA, 0x44, 0xAA, 
0x01, 0xAA, 0x44, 0xAA, 0x10, 0xAA, 0x44, 0xAA, 
0x00, 0xAA, 0x44, 0xAA, 0x10, 0xAA, 0x44, 0xAA, 
0x00, 0xAA, 0x44, 0xAA, 0x00, 0xAA, 0x44, 0xAA, 
0x00, 0xAA, 0x04, 0xAA, 0x00, 0xAA, 0x44, 0xAA, 
0x00, 0xAA, 0x04, 0xAA, 0x00, 0xAA, 0x40, 0xAA, 
0x00, 0xAA, 0x00, 0xAA, 0x00, 0xAA, 0x40, 0xAA, 
0x00, 0xAA, 0x00, 0xAA, 0x00, 0xAA, 0x00, 0xAA, 
0x00, 0x2A, 0x00, 0xAA, 0x00, 0xAA, 0x00, 0xAA, 
0x00, 0x2A, 0x00, 0xAA, 0x00, 0xA2, 0x00, 0xAA, 
0x00, 0x22, 0x00, 0xAA, 0x00, 0xA2, 0x00, 0xAA, 
0x00, 0x22, 0x00, 0xAA, 0x00, 0x22, 0x00, 0xAA, 
0x00, 0x22, 0x00, 0x8A, 0x00, 0x22, 0x00, 0xAA, 
0x00, 0x22, 0x00, 0x8A, 0x00, 0x22, 0x00, 0xA8, 
0x00, 0x22, 0x00, 0x88, 0x00, 0x22, 0x00, 0xA8, 
0x00, 0x22, 0x00, 0x88, 0x00, 0x22, 0x00, 0x88, 
0x00, 0x02, 0x00, 0x88, 0x00, 0x22, 0x00, 0x88, 
0x00, 0x02, 0x00, 0x88, 0x00, 0x20, 0x00, 0x88, 
0x00, 0x00, 0x00, 0x88, 0x00, 0x20, 0x00, 0x88, 
0x00, 0x00, 0x00, 0x88, 0x00, 0x00, 0x00, 0x88, 
0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x88, 
0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x80, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

void pall_rgb( PICTURE *fi )
{
  int i, rgb;
  unsigned int *pix;
  unsigned char **pal;

  pal = fi->palette;
  pix = (unsigned int *)&fi->intens[0][0];
  for( i=fi->colors; --i>=0; )
  {
    rgb = ((long)(*pix++ * 30) + (long)(*pix++ * 59) +
        (long)(*pix++ * 11)) * 64 / 100000;
    *pal++ = &floydbytes[rgb][0];
  }
}

unsigned int *rgb2( unsigned int *v, int *val )
{
  unsigned int i;
  
  i = *v++;
  *val = (((i>>10)&0x1f)*30 + ((i>>5)&0x1f)*59 + (i&0x1f)*11) * 64L / 3100L;
  return v;
}

unsigned int *rgb3( unsigned int *v, int *val )
{
  *val = ( *((unsigned char *)v)++ * 30 +
           *((unsigned char *)v)++ * 59 +
           *((unsigned char *)v)++ * 11 ) * 64L / 25500L;
  return v;
}

void ditherpal( PICTURE *fi, int extra )
{
  int i, j, k, m, d, b, p, w;
  unsigned int buf[24], *v, *v2, *bp;
  long pllen, lastpl;

    pall_rgb( fi );
    lastpl = (pllen = (long)(fi->mfdb.fd_wdwidth<<1)*fi->mfdb.fd_h) *
        (fi->mfdb.fd_nplanes-1);
    for( v=fi->mfdb.fd_addr, j=fi->mfdb.fd_h; --j>=0; )
      for( d=j&7, i=fi->mfdb.fd_w; i>0; i-=16 )
      {
        if( i>15 )
        {
          for( bp=buf, v2=(unsigned int *)((char *)v+lastpl), p=fi->mfdb.fd_nplanes;
              --p>=0; v2=(unsigned int *)((char *)v2-pllen) )
            *bp++ = *v2;
          k = 16;
        }
        else 
        {
          for( bp=buf, v2=(unsigned int *)((char *)v+lastpl), p=fi->mfdb.fd_nplanes;
              --p>=0; v2=(unsigned int *)((char *)v2-pllen) )
          *bp++ = *v2>>(16-i);
          k = i;
        }
        b = m = 0;
        while( --k>=0 )
        {
          w = 0;
          for( bp=buf, p=fi->mfdb.fd_nplanes; --p>=0; )
            w = (w+w) | ((*bp++>>k)&1);
          b = (b+b) | ((fi->palette[w][d]>>(m++&7))&1);
        }
        if( i<15 ) b <<= extra;
        *v++ = b;
      }
}

void dithertc( PICTURE *fi, int extra )
{
  int i, j, k, m, d, b, w;
  unsigned int *v, *v2;
  unsigned int *(*rgbfunc)( unsigned int *v, int *val );

    rgbfunc = fi->mfdb.fd_nplanes==24 ? rgb3 : rgb2;
    for( v2=v=fi->mfdb.fd_addr, j=fi->mfdb.fd_h; --j>=0; )
      for( d=j&7, i=fi->mfdb.fd_w; i>0; i-=16 )
      {
        k = i>15 ? 16 : i;
        b = m = 0;
        while( --k>=0 )
        {
          v = (*rgbfunc)( v, &w );
          b = (b+b) | ((floydbytes[w][d]>>(m++&7))&1);
        }
        if( i<15 )
        {
          b <<= extra;
          v = (unsigned int *)((unsigned char *)v +
              (fi->mfdb.fd_nplanes==24 ? 3*extra : extra<<1));
        }
        *v2++ = b;
      }
}

void ditherfile( PICTURE *fi )
{
  int extra = 16-(fi->mfdb.fd_w&0xf);

  if( fi->palette ) ditherpal( fi, extra );
  else dithertc( fi, extra );
}
